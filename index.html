<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>0107 Happy Birthday</title>
    <style>
        :root {
            --primary-color: #ff9a9e;
            --secondary-color: #fad0c4;
            --card-bg: #fffdf9;
            --text-color: #555;
            --heart-color: #ff4d6d;
            --glow-color: rgba(255, 154, 158, 0.3);
            --gold: #ffd700;
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
            font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif;
            overflow: hidden;
            user-select: none;
            position: relative;
        }

        /* === å…¨åŸŸç‰¹æ•ˆ === */
        #canvas-trail { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }

        /* éŸ³æ¨‚æ§åˆ¶æŒ‰éˆ• */
        #music-control {
            position: fixed; top: 20px; right: 20px; width: 44px; height: 44px;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 200; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255,255,255,0.5);
            display: none; /* åˆå§‹éš±è—ï¼ŒåŠ è¼‰æˆåŠŸæ‰é¡¯ç¤º */
        }
        #music-control.ready { display: flex; }
        #music-control:hover { transform: scale(1.1); }
        .music-icon { font-size: 22px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }

        .container {
            position: absolute; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-in-out, transform 0.8s ease-in-out;
            opacity: 0; pointer-events: none; z-index: 0;
            transform: scale(0.95);
        }
        .container.active { opacity: 1; pointer-events: auto; z-index: 30; transform: scale(1); }

        /* === Stage 0: å¯†ç¢¼é– === */
        #stage-lock { background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(235,237,238,0.4) 100%); z-index: 100; }
        .lock-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            padding: 50px 30px;
            border-radius: 35px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.6);
            text-align: center;
            max-width: 320px;
            width: 85%;
            animation: cardFloat 4s ease-in-out infinite;
        }
        @keyframes cardFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }

        .lock-title { color: #888; font-size: 15px; letter-spacing: 5px; margin-bottom: 25px; font-weight: bold; }
        
        .pass-input-wrapper { position: relative; display: inline-block; }
        input[type="text"] {
            font-size: 32px; padding: 12px; width: 180px; text-align: center;
            border: none; border-bottom: 3px solid #f0f0f0; outline: none; background: transparent;
            letter-spacing: 10px; margin-bottom: 15px; color: #ff9a9e; transition: 0.3s;
            font-weight: bold;
        }
        input[type="text"]:focus { border-bottom-color: var(--primary-color); }
        input[type="text"]::placeholder { letter-spacing: 2px; font-size: 16px; color: #ddd; font-weight: normal; }

        .error-shake { animation: shakeError 0.4s ease-in-out; }
        @keyframes shakeError {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-10px); }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { transform: translateX(10px); }
        }

        /* === Stage 1: æµªæ¼«æ°›åœ === */
        .float-msg {
            position: absolute; padding: 15px 30px;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(135deg, #ff9a9e 0%, #fbc2eb 100%) border-box;
            border: 2px solid transparent;
            backdrop-filter: blur(8px);
            border-radius: 20px;
            box-shadow: 0 10px 25px var(--glow-color);
            color: #444; font-size: 17px; font-weight: 500;
            font-family: "Palatino Linotype", serif; letter-spacing: 1px;
            animation: driftUpText 6s ease-out forwards, pulseGlow 3s infinite ease-in-out;
            pointer-events: auto; z-index: 10;
            min-width: 140px; text-align: center;
        }
        .float-msg::after { content: 'âœ¨'; position: absolute; top: -10px; right: -10px; font-size: 16px; filter: drop-shadow(0 0 5px var(--primary-color)); }
        @keyframes pulseGlow { 0%, 100% { box-shadow: 0 10px 25px var(--glow-color); } 50% { box-shadow: 0 15px 35px rgba(255, 154, 158, 0.5); } }
        @keyframes driftUpText { 0% { transform: translateY(0) scale(0.85); opacity: 0; } 15% { opacity: 1; transform: translateY(-30px) scale(1); } 85% { opacity: 1; } 100% { transform: translateY(-350px) scale(0.95); opacity: 0; } }

        .main-btn {
            margin-top: 30px; padding: 12px 35px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white; border: none; border-radius: 50px; font-size: 16px; cursor: pointer;
            transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 8px 20px rgba(255, 154, 158, 0.3);
            opacity: 0; transform: translateY(30px) scale(0.8);
            pointer-events: none;
            z-index: 1;
        }
        /* ç‰¹åˆ¥èª¿æ•´ã€Œæ”¶ä¸‹é©šå–œã€æŒ‰éˆ•çš„ä½ç½® */
        #nextLevelBtn {
            position: absolute;
            bottom: 22%; /* å¾€ä¸‹ä¸€é» */
        }
        .main-btn.show { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; z-index: 100; }
        .main-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 25px rgba(255, 154, 158, 0.5); }

        #progressHint { position: absolute; bottom: 12%; color: #bbb; font-size: 13px; letter-spacing: 1px; transition: opacity 0.5s; z-index: 50; }

        /* === Stage 2: ç¦®ç‰©ç›’ === */
        #stage-box { overflow: visible; }
        .box-container { position: relative; width: 200px; height: 200px; display: flex; justify-content: center; align-items: center; perspective: 1000px; cursor: pointer;}
        .box-emoji { font-size: 120px; filter: drop-shadow(0 15px 30px rgba(0,0,0,0.1)); transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 5; }
        .shockwave { position: absolute; border: 3px solid var(--primary-color); border-radius: 50%; width: 100px; height: 100px; pointer-events: none; opacity: 0; z-index: 1; }
        @keyframes shock { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(3); opacity: 0; } }
        .debris { position: absolute; pointer-events: none; font-size: 20px; z-index: 10; }
        @keyframes scatter { 0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) rotate(var(--tr)) scale(0); opacity: 0; } }
        .shake-heavy { animation: shakeHeavy 0.4s infinite; }
        @keyframes shakeHeavy { 0% { transform: translate(0, 0) rotate(0deg); } 20% { transform: translate(-5px, 5px) rotate(-3deg); } 40% { transform: translate(5px, -5px) rotate(3deg); } 60% { transform: translate(-5px, -5px) rotate(-3deg); } 80% { transform: translate(5px, 5px) rotate(3deg); } 100% { transform: translate(0, 0) rotate(0deg); } }
        #progressBarContainer { width: 220px; height: 12px; background: #eee; border-radius: 10px; margin-top: 50px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        #progressBar { width: 0%; height: 100%; background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); transition: width 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* === Stage 3: è¯éº—æ­æ›‰ === */
        #stage-reveal { background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(255,236,240,1) 100%); }
        .sunburst-container { position: absolute; width: 600px; height: 600px; display: flex; justify-content: center; align-items: center; z-index: 1; pointer-events: none; }
        .sunburst { position: absolute; width: 100%; height: 100%; background: repeating-conic-gradient(from 0deg, transparent 0deg 15deg, rgba(255, 215, 0, 0.1) 15deg 30deg); animation: rotateSunburst 20s linear infinite; mask-image: radial-gradient(circle, black 30%, transparent 70%); }
        @keyframes rotateSunburst { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .prize-card { background: white; padding: 40px 30px; border-radius: 20px; border: 4px double var(--gold); box-shadow: 0 20px 50px rgba(0,0,0,0.1), inset 0 0 20px rgba(255, 215, 0, 0.1); position: relative; z-index: 5; text-align: center; max-width: 280px; animation: prizePopIn 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes prizePopIn { 0% { transform: scale(0.5) translateY(50px) rotate(-5deg); opacity: 0; } 100% { transform: scale(1) translateY(0) rotate(0deg); opacity: 1; } }
        .prize-badge { background: var(--gold); color: #856404; font-size: 12px; font-weight: bold; padding: 5px 15px; border-radius: 20px; position: absolute; top: -15px; left: 50%; transform: translateX(-50%); box-shadow: 0 4px 10px rgba(0,0,0,0.1); white-space: nowrap; }
        .reveal-content { font-size: 28px; font-weight: 800; color: #444; margin: 10px 0; white-space: pre-wrap; line-height: 1.4; background: linear-gradient(45deg, #d4af37, #444); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .prize-sparkle { position: absolute; width: 10px; height: 10px; background: var(--gold); clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); animation: sparkleAnim 1.5s infinite; }
        @keyframes sparkleAnim { 0%, 100% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.5); opacity: 1; } }

        /* === Stage 4: å¡ç‰‡ === */
        .card-style { background-color: var(--card-bg); background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E"); padding: 40px 30px; border-radius: 24px; text-align: center; max-width: 340px; width: 88%; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 1px solid #f0e6e6; max-height: 85vh; overflow-y: auto; }
        .message-text { color: #555; font-size: 15px; line-height: 1.8; font-family: "Noto Serif TC", serif; text-align: left;}
        .highlight { color: #d87a7a; font-weight: bold; border-bottom: 2px solid #fad0c4; }
        .confetti { position: absolute; width: 10px; height: 10px; z-index: 50; pointer-events: none; }
    </style>
</head>
<body>

    <canvas id="canvas-trail"></canvas>

    <!-- éŸ³æ¨‚æ§åˆ¶ -->
    <div id="music-control" title="åˆ‡æ›éŸ³æ¨‚">
        <span class="music-icon" id="music-status">ğŸ”ˆ</span>
    </div>
    <!-- éŸ³æºï¼šæ›´æ›ç‚ºè¼ƒç©©å®šçš„ä¾†æº -->
    <audio id="bgMusic" loop preload="auto">
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3" type="audio/mpeg">
    </audio>

    <!-- Stage 0: Lock Screen -->
    <div id="stage-lock" class="container active">
        <div class="lock-card" id="lockCard">
            <div class="lock-title">ç‹äº®æ™´'s Birthday</div>
            <div style="font-size: 45px; margin-bottom: 20px;">ğŸ”’</div>
            <div class="pass-input-wrapper">
                <input type="text" id="passInput" placeholder="è«‹è¼¸å…¥æ—¥æœŸ" maxlength="4" inputmode="numeric">
            </div>
            <p style="color: #bbb; font-size: 13px; margin-top: 15px; letter-spacing: 1px;">è¼¸å…¥å¯†ç¢¼è§£é–é©šå–œ</p>
        </div>
    </div>

    <!-- Stage 1 -->
    <div id="stage-text" class="container">
        <div id="progressHint">æ­£åœ¨ç‚ºå¦³æ”¶é›†é©šå–œä¸­...</div>
        <button id="nextLevelBtn" class="main-btn">âœ¨ æ”¶ä¸‹é©šå–œ</button>
    </div>

    <!-- Stage 2 -->
    <div id="stage-box" class="container">
        <div id="boxStatus" style="color:#f8a3a8; font-weight: bold; margin-bottom: 15px; font-size: 20px; height: 24px;">ç”¨åŠ›é»å®ƒï¼</div>
        <div class="box-container" id="boxContainer">
            <div class="box-emoji" id="giftBox">ğŸ</div>
        </div>
        <div id="progressBarContainer"><div id="progressBar"></div></div>
        <div style="margin-top: 15px; color: #aaa; font-size: 12px;">é»æ“Šæ‰“é–‹é€™ä»½ç¦®ç‰©</div>
    </div>

    <!-- Stage 3 Reveal -->
    <div id="stage-reveal" class="container">
        <div class="sunburst-container"><div class="sunburst"></div></div>
        <div class="prize-card" id="prizeCard">
            <div class="prize-badge">âœ¨ SPECIAL GIFT âœ¨</div>
            <div style="font-size: 16px; color: #888; margin-bottom: 10px;">æ­å–œç²å¾—</div>
            <div id="finalPrizeText" class="reveal-content">...</div>
            <div style="font-size: 12px; color: #bbb; margin-top: 15px;">æ­¤åˆ¸æ°¸ä¹…æœ‰æ•ˆï¼Œéš¨æ™‚å…Œæ›</div>
        </div>
        <button id="goToCardBtn" class="main-btn show" style="margin-top: 40px;">ğŸ’Œ è®€ä¸€å°ä¿¡</button>
    </div>

    <!-- Stage 4 -->
    <div id="stage-card" class="container">
        <div class="card-style">
            <div id="card-title" style="font-size: 13px; color: var(--primary-color); letter-spacing: 4px; font-weight: bold; margin-bottom: 25px;">MEMORIES & WISHES</div>
            <div class="message-text">
                <span id="card-opening" style="font-size: 18px; font-weight: bold; display:block; margin-bottom: 15px; color: #333;"></span>
                <div id="card-body"></div>
            </div>
            <div id="card-signature" style="font-size: 14px; color: #888; margin-top: 30px; text-align: right; font-weight: bold;"></div>
        </div>
    </div>

    <script>
        const APP_CONTENT = {
            passcode: "0107",
            spawnRate: 500, 
            behaviorAfterFinish: 'random', 
            floatingTexts: [
                "ç‹äº®æ™´ ç”Ÿæ—¥å¿«æ¨‚ï¼", "é¡˜å¦³çœ¼è£¡æ°¸é æœ‰å…‰", "ä»Šå¤©çš„å¦³ç‰¹åˆ¥è€€çœ¼",
                "è¦æŠŠç…©æƒ±éƒ½æ¸…ç©ºå–”", "è¬è¬å¦³çš„å­˜åœ¨", "åœ¨æˆ‘å¿ƒè£¡å¦³æ°¸é æ˜¯æœ€æ£’çš„",
                "æƒ³å“­çš„æ™‚å€™ï¼Œè¨˜å¾—æœ‰æˆ‘", "å¦³æ˜¯é€™ä¸–ç•Œä¸Šæœ€ç¨ä¸€ç„¡äºŒçš„", "é€™æ˜¯å±¬æ–¼å¦³çš„ä¸€å¤©",
                "ä¸ç®¡ç™¼ç”Ÿä»€éº¼æˆ‘éƒ½åœ¨", "è¦å¤©å¤©é–‹å¿ƒ", "å¦³ä¸æ˜¯åªæœ‰ä¸€å€‹äºº",
                "ç´¯äº†å°±æŠ±æŠ±è‡ªå·±", "æˆ‘æ°¸é ç«™åœ¨å¦³é€™é‚Š", "âœ¨ Happy Birthday âœ¨"
            ],
            prizes: [
                "è«‹å–ä¸€æ¯é£²æ–™åˆ¸\n(å£å‘³ä»»é¸)", "ç„¡æ¢ä»¶è½å¦³æŠ±æ€¨åˆ¸\n(éš¨æ™‚æœ‰æ•ˆ)",
                "çœŸå¿ƒè©±åˆ¸\n(å¯ä»¥å•æˆ‘ä»»ä½•æ±è¥¿å–”)", "è¬èƒ½è¨±é¡˜åˆ¸\n(å¦³èªªä»€éº¼å°±æ˜¯ä»€éº¼)",
                "é»å¿ƒé¤µé£Ÿåˆ¸\n(éš¨æ©Ÿæ‰è½é›¶é£Ÿ)"
            ],
            cardOpening: "Dear å¯æ„›æ•¸å­¸å°è€å¸«ï¼š",
            cardBody: `é€™æ˜¯æˆ‘å€‘ç›¸è­˜å¾Œçš„ç¬¬äºŒå€‹ç”Ÿæ—¥ã€‚å›é¦–é€™æ®µæ—¥å­ï¼Œé›–ç„¶æˆ‘å€‘æ›¾ä¸€èµ·èµ°éä¸€äº›é›¨å¤©ï¼Œä¹Ÿç¶“æ­·éäº›è¨±ç£•çµ†ï¼Œä½†æ­£æ˜¯é€™äº›ä¸å®Œç¾ï¼Œè®“æˆ‘æ›´çæƒœç¾åœ¨èƒ½ä»¥æœ‹å‹èº«åˆ†é™ªåœ¨å¦³èº«é‚Šçš„æ™‚åˆ»ã€‚<br><br>
                       è¬è¬å¦³ä¸€ç›´ä»¥ä¾†çš„åŒ…å®¹èˆ‡é™ªä¼´ï¼Œå¦³çš„å–„è‰¯èˆ‡çŸ¥æ€§æ˜¯æˆ‘ç”Ÿå‘½ä¸­å¾ˆç‰¹åˆ¥çš„å­˜åœ¨ã€‚éå»çš„æ­²æœˆæ„Ÿè¬æœ‰å¦³åƒèˆ‡ï¼Œæœªä¾†çš„æ—¥å­ï¼Œä¹Ÿè«‹è®“æˆ‘å€‘ç¹¼çºŒä¸¦è‚©å‰è¡Œï¼Œäº’ç›¸æŒ‡æ•™ã€‚<br><br>
                       <span class="highlight">èƒ½é‡è¦‹å¦³ï¼Œæ˜¯æˆ‘é€™ä»½äººç”Ÿè€ƒå·è£¡æœ€å¹¸é‹çš„ç­”æ¡ˆã€‚</span><br><br>
                       ç¥å¦³ ç”Ÿæ—¥å¿«æ¨‚ï¼Œé¡˜å¦³æ¯ä¸€å¤©éƒ½å……æ»¿ç¬‘å®¹`,
            cardSignature: "æ—åšç¨‹ æ•¬ä¸Š"
        };

        // æ–‡å­—åˆå§‹åŒ–
        document.getElementById('card-opening').innerText = APP_CONTENT.cardOpening;
        document.getElementById('card-body').innerHTML = APP_CONTENT.cardBody;
        document.getElementById('card-signature').innerText = APP_CONTENT.cardSignature;

        const music = document.getElementById('bgMusic');
        const musicBtn = document.getElementById('music-control');
        const musicStatus = document.getElementById('music-status');

        // éŸ³è¨Šæª¢æŸ¥ï¼šç¢ºä¿é€£çµå¯ç”¨æ‰é¡¯ç¤ºæŒ‰éˆ•
        music.addEventListener('canplaythrough', () => {
            musicBtn.classList.add('ready');
        });

        // éœé»˜è™•ç†åŠ è¼‰éŒ¯èª¤
        music.addEventListener('error', (e) => {
            console.warn("Music source could not be loaded. App will continue without audio.");
            musicBtn.style.display = 'none';
        });

        function toggleMusic() {
            if (music.paused) {
                music.play().then(() => {
                    musicStatus.innerText = "ğŸ”Š";
                }).catch(err => console.log("Play rejected"));
            } else {
                music.pause();
                musicStatus.innerText = "ğŸ”ˆ";
            }
        }
        musicBtn.onclick = toggleMusic;

        // æ»‘é¼ è»Œè·¡
        const canvas = document.getElementById('canvas-trail');
        const ctx = canvas.getContext('2d');
        let particles = [];
        const colors = ['#ff9a9e', '#fad0c4', '#fbc2eb', '#ffffff'];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();
        const createParticle = (x, y) => {
            particles.push({ x, y, text: 'â™¥', color: colors[Math.floor(Math.random() * colors.length)], size: Math.random() * 15 + 8, speedX: Math.random() * 2 - 1, speedY: Math.random() * 2 - 1, life: 1 });
        }
        window.addEventListener('mousemove', e => createParticle(e.clientX, e.clientY));
        window.addEventListener('touchmove', e => createParticle(e.touches[0].clientX, e.touches[0].clientY));
        function animateTrail() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, i) => { p.x += p.speedX; p.y += p.speedY; p.life -= 0.03; p.size *= 0.95; ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.font = `bold ${p.size}px sans-serif`; ctx.fillText(p.text, p.x, p.y); });
            particles = particles.filter(p => p.life > 0);
            requestAnimationFrame(animateTrail);
        }
        animateTrail();

        // å¯†ç¢¼é©—è­‰
        const passInput = document.getElementById('passInput');
        const lockCard = document.getElementById('lockCard');

        passInput.addEventListener('input', (e) => {
            if(e.target.value.length === 4) {
                if(e.target.value === APP_CONTENT.passcode) {
                    passInput.blur();
                    // å˜—è©¦æ’­æ”¾éŸ³æ¨‚
                    music.play().then(() => {
                        musicStatus.innerText = "ğŸ”Š";
                        musicBtn.classList.add('ready');
                    }).catch(e => console.log("Autoplay blocked by browser policy"));
                    
                    switchStage('stage-lock', 'stage-text');
                    startFloatingSequence();
                } else {
                    lockCard.classList.add('error-shake');
                    setTimeout(() => { 
                        lockCard.classList.remove('error-shake'); 
                        e.target.value = ""; 
                    }, 400);
                }
            }
        });

        function startFloatingSequence() {
            const stageText = document.getElementById('stage-text');
            const nextBtn = document.getElementById('nextLevelBtn');
            const hint = document.getElementById('progressHint');
            let textCounter = 0;
            const totalTexts = APP_CONTENT.floatingTexts.length;
            const interval = setInterval(() => {
                let textContent = "";
                if (textCounter < totalTexts) textContent = APP_CONTENT.floatingTexts[textCounter];
                else {
                    if (APP_CONTENT.behaviorAfterFinish === 'stop') { clearInterval(interval); return; }
                    else if (APP_CONTENT.behaviorAfterFinish === 'random') textContent = APP_CONTENT.floatingTexts[Math.floor(Math.random() * totalTexts)];
                    else textContent = APP_CONTENT.floatingTexts[textCounter % totalTexts];
                }
                const el = document.createElement('div');
                el.className = 'float-msg';
                const rx = (textCounter % 2 === 0) ? (15 + Math.random() * 20) : (50 + Math.random() * 20);
                const ry = 25 + (Math.random() * 40); // ç¨å¾®å¾€ä¸Šä¸€é»ï¼Œä¸è“‹åˆ°æŒ‰éˆ•
                el.style.left = rx + '%'; el.style.top = ry + '%';
                stageText.appendChild(el);
                let i = 0;
                function type() { if (i < textContent.length) { el.innerHTML += textContent.charAt(i); i++; setTimeout(type, 45); } }
                type();
                textCounter++;
                if (textCounter >= totalTexts) { nextBtn.classList.add('show'); hint.style.opacity = '0'; }
                else { hint.innerText = `æ­£åœ¨ç‚ºå¦³æ”¶é›†é©šå–œä¸­ (${textCounter}/${totalTexts})`; }
                setTimeout(() => el.remove(), 6000);
            }, APP_CONTENT.spawnRate);
            nextBtn.onclick = () => { clearInterval(interval); switchStage('stage-text', 'stage-box'); };
        }

        // ç¦®ç‰©ç›’é‚è¼¯
        let clickCount = 0;
        const maxClicks = 10;
        const boxContainer = document.getElementById('boxContainer');
        const box = document.getElementById('giftBox');
        const statusText = document.getElementById('boxStatus');
        const pBar = document.getElementById('progressBar');
        const statusMessages = ["åŠ æ²¹ï¼", "ç”¨åŠ›é»ï¼", "å¿«é–‹äº†ï¼", "é‚„å·®ä¸€é»é»ï¼", "æœ€å¾Œä¸€ä¸‹ï¼", "å°±è¦å‡ºä¾†äº†ï¼"];
        const debrisShapes = ["âœ¨", "ğŸ’–", "â­", "ğŸ€", "ğŸˆ"];

        boxContainer.onclick = () => {
            if (clickCount >= maxClicks) return;
            clickCount++;
            const progress = (clickCount / maxClicks) * 100;
            pBar.style.width = progress + '%';
            box.style.transform = `scale(${1 + clickCount * 0.08}) rotate(${clickCount % 2 === 0 ? 5 : -5}deg)`;
            if (clickCount % 2 === 0) statusText.innerText = statusMessages[Math.floor(Math.random() * statusMessages.length)];
            const sw = document.createElement('div'); sw.className = 'shockwave'; sw.style.animation = 'shock 0.6s ease-out forwards'; boxContainer.appendChild(sw); setTimeout(() => sw.remove(), 600);
            for (let i = 0; i < 5; i++) {
                const deb = document.createElement('div'); deb.className = 'debris'; deb.innerText = debrisShapes[Math.floor(Math.random() * debrisShapes.length)];
                const tx = (Math.random() - 0.5) * 300; const ty = (Math.random() - 0.5) * 300 - 50; const tr = Math.random() * 360;
                deb.style.setProperty('--tx', `${tx}px`); deb.style.setProperty('--ty', `${ty}px`); deb.style.setProperty('--tr', `${tr}deg`); deb.style.animation = 'scatter 0.8s ease-out forwards';
                boxContainer.appendChild(deb); setTimeout(() => deb.remove(), 800);
            }
            if (clickCount >= maxClicks) {
                statusText.innerText = "é–‹å•¦ï¼ğŸ‰"; box.classList.add('shake-heavy');
                setTimeout(() => {
                    const prize = APP_CONTENT.prizes[Math.floor(Math.random() * APP_CONTENT.prizes.length)];
                    document.getElementById('finalPrizeText').innerText = prize;
                    switchStage('stage-box', 'stage-reveal');
                    addRevealSparkles(); startConfetti();
                }, 1000);
            }
        };

        function addRevealSparkles() {
            const container = document.getElementById('stage-reveal');
            for(let i=0; i<15; i++) {
                const s = document.createElement('div'); s.className = 'prize-sparkle'; s.style.left = Math.random() * 100 + '%'; s.style.top = Math.random() * 100 + '%'; s.style.animationDelay = Math.random() * 2 + 's'; container.appendChild(s);
            }
        }

        document.getElementById('goToCardBtn').onclick = () => switchStage('stage-reveal', 'stage-card');

        function switchStage(hide, show) { 
            document.getElementById(hide).classList.remove('active'); 
            setTimeout(() => document.getElementById(show).classList.add('active'), 600); 
        }

        function startConfetti() {
            for(let i=0; i<120; i++) {
                let c = document.createElement('div'); c.className = 'confetti'; c.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)]; c.style.left = Math.random()*100 + 'vw'; c.style.top = '-10px'; c.style.width = Math.random()*12+6+'px'; c.style.height = c.style.width; c.style.animation = `drop ${Math.random()*3+2}s forwards`; document.body.appendChild(c);
            }
            if(!document.getElementById('confetti-style')) {
                let s = document.createElement('style'); s.id = 'confetti-style'; s.innerHTML = `@keyframes drop { to { transform: translateY(110vh) rotate(720deg); opacity: 0; } }`; document.head.appendChild(s);
            }
        }
    </script>
</body>
</html>
